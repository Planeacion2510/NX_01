{% extends 'base.html' %}
{% load static %}

{% block title %}Clima Organizacional{% endblock %}

{% block extra_css %}
<style>
    .clima-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .score-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .score-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        position: relative;
    }
    
    .score-circle::before {
        content: '';
        position: absolute;
        inset: 8px;
        border-radius: 50%;
        background: white;
        z-index: 0;
    }
    
    .score-content {
        position: relative;
        z-index: 1;
    }
    
    .score-number {
        font-size: 3rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .score-label {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .dimension-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    
    .dimension-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .dimension-score {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .dimension-bar {
        height: 12px;
        border-radius: 10px;
        background: #f0f0f0;
        overflow: hidden;
        position: relative;
    }
    
    .dimension-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }
    
    .nivel-excelente { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
    .nivel-bueno { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); }
    .nivel-regular { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
    .nivel-deficiente { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); }
    
    .encuesta-card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .stat-mini {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .stat-mini .number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-mini .label {
        font-size: 0.8rem;
        color: #666;
    }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .participacion-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .comentario-card {
        background: #f8f9fa;
        border-left: 3px solid #667eea;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    
    .nivel-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Header -->
    <div class="clima-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-2">📊 Medición de Clima Organizacional</h1>
                <p class="mb-0 opacity-75">
                    Análisis del ambiente laboral y satisfacción del equipo
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'talento_humano:crear_encuesta_clima' %}" class="btn btn-light btn-lg">
                    <i class="bi bi-plus-circle"></i> Nueva Encuesta
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        
        <!-- Columna izquierda: Score y dimensiones -->
        <div class="col-md-8">
            
            <!-- Score general del clima -->
            <div class="score-card mb-4">
                <h5 class="mb-4">Clima Organizacional Actual</h5>
                
                <div class="score-circle">
                    <div class="score-content">
                        <div class="score-number">{{ clima_score|floatformat:1 }}</div>
                        <div class="score-label">de 5.0</div>
                    </div>
                </div>
                
                <h4 class="mb-2">
                    {% if clima_score >= 4.5 %}Excelente
                    {% elif clima_score >= 3.5 %}Bueno
                    {% elif clima_score >= 2.5 %}Regular
                    {% else %}Deficiente
                    {% endif %}
                </h4>
                
                <p class="text-muted">
                    Basado en {{ total_respuestas }} respuestas de {{ total_empleados }} empleados
                </p>
                
                <!-- Tasa de participación -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">Tasa de Participación</small>
                        <strong>{{ tasa_participacion }}%</strong>
                    </div>
                    <div class="dimension-bar">
                        <div class="dimension-fill 
                            {% if tasa_participacion >= 80 %}nivel-excelente
                            {% elif tasa_participacion >= 60 %}nivel-bueno
                            {% elif tasa_participacion >= 40 %}nivel-regular
                            {% else %}nivel-deficiente
                            {% endif %}"
                             style="width: {{ tasa_participacion }}%">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dimensiones evaluadas -->
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="bi bi-bar-chart"></i> Dimensiones Evaluadas
                </h5>
                
                {% if dimensiones %}
                {% for dimension in dimensiones %}
                <div class="dimension-card">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <strong>{{ dimension.nombre }}</strong>
                            <br>
                            <small class="text-muted">{{ dimension.descripcion }}</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <div class="dimension-score 
                                {% if dimension.puntaje >= 4.5 %}text-success
                                {% elif dimension.puntaje >= 3.5 %}text-primary
                                {% elif dimension.puntaje >= 2.5 %}text-warning
                                {% else %}text-danger
                                {% endif %}">
                                {{ dimension.puntaje|floatformat:1 }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="dimension-bar">
                                <div class="dimension-fill 
                                    {% if dimension.puntaje >= 4.5 %}nivel-excelente
                                    {% elif dimension.puntaje >= 3.5 %}nivel-bueno
                                    {% elif dimension.puntaje >= 2.5 %}nivel-regular
                                    {% else %}nivel-deficiente
                                    {% endif %}"
                                     style="width: {{ dimension.porcentaje }}%">
                                </div>
                            </div>
                            <small class="text-muted">{{ dimension.porcentaje }}%</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                    <p class="mt-2">No hay dimensiones evaluadas aún</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Fortalezas y oportunidades de mejora -->
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="text-success">
                            <i class="bi bi-hand-thumbs-up-fill"></i> Fortalezas
                        </h6>
                        {% if fortalezas %}
                        <ul class="list-unstyled">
                            {% for fortaleza in fortalezas %}
                            <li class="mb-2">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <strong>{{ fortaleza.dimension }}:</strong>
                                <span class="text-success">{{ fortaleza.puntaje|floatformat:1 }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted small">No hay datos suficientes</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="text-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i> Oportunidades de Mejora
                        </h6>
                        {% if oportunidades %}
                        <ul class="list-unstyled">
                            {% for oportunidad in oportunidades %}
                            <li class="mb-2">
                                <i class="bi bi-arrow-up-circle-fill text-warning"></i>
                                <strong>{{ oportunidad.dimension }}:</strong>
                                <span class="text-warning">{{ oportunidad.puntaje|floatformat:1 }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted small">No hay datos suficientes</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Comentarios destacados -->
            {% if comentarios %}
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="bi bi-chat-left-quote"></i> Comentarios del Equipo
                </h5>
                
                {% for comentario in comentarios %}
                <div class="comentario-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">
                            <i class="bi bi-person-circle"></i> Anónimo
                        </small>
                        <small class="text-muted">{{ comentario.fecha|date:"d/m/Y" }}</small>
                    </div>
                    <p class="mb-0">{{ comentario.texto }}</p>
                </div>
                {% endfor %}
                
                <div class="text-center mt-3">
                    <a href="{% url 'talento_humano:todos_comentarios_clima' %}" class="btn btn-sm btn-outline-primary">
                        Ver Todos los Comentarios
                    </a>
                </div>
            </div>
            {% endif %}
            
        </div>
        
        <!-- Columna derecha: Encuestas e información -->
        <div class="col-md-4">
            
            <!-- Estadísticas rápidas -->
            <div class="chart-container">
                <h6 class="mb-3">Estadísticas Generales</h6>
                
                <div class="stat-mini">
                    <div class="number">{{ total_encuestas }}</div>
                    <div class="label">Encuestas Realizadas</div>
                </div>
                
                <div class="stat-mini">
                    <div class="number">{{ promedio_participacion }}%</div>
                    <div class="label">Participación Promedio</div>
                </div>
                
                <div class="stat-mini">
                    <div class="number">{{ total_respuestas }}</div>
                    <div class="label">Respuestas Totales</div>
                </div>
            </div>
            
            <!-- Encuestas recientes -->
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="bi bi-clipboard-data"></i> Encuestas Recientes
                </h6>
                
                {% if encuestas_recientes %}
                {% for encuesta in encuestas_recientes %}
                <div class="encuesta-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>{{ encuesta.titulo }}</strong>
                        <span class="nivel-badge
                            {% if encuesta.estado == 'activa' %}bg-success text-white
                            {% elif encuesta.estado == 'cerrada' %}bg-secondary text-white
                            {% else %}bg-warning text-dark
                            {% endif %}">
                            {{ encuesta.get_estado_display }}
                        </span>
                    </div>
                    
                    <div class="small text-muted mb-2">
                        <i class="bi bi-calendar"></i>
                        {{ encuesta.fecha_inicio|date:"d/m/Y" }} - {{ encuesta.fecha_fin|date:"d/m/Y" }}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small>
                            <i class="bi bi-people"></i>
                            {{ encuesta.respuestas_count }} respuestas
                        </small>
                        <span class="participacion-badge
                            {% if encuesta.tasa_participacion >= 80 %}bg-success text-white
                            {% elif encuesta.tasa_participacion >= 60 %}bg-primary text-white
                            {% elif encuesta.tasa_participacion >= 40 %}bg-warning text-dark
                            {% else %}bg-danger text-white
                            {% endif %}">
                            {{ encuesta.tasa_participacion }}%
                        </span>
                    </div>
                    
                    <div class="mt-2">
                        <a href="{% url 'talento_humano:resultados_encuesta' encuesta.pk %}" 
                           class="btn btn-sm btn-outline-primary w-100">
                            <i class="bi bi-graph-up"></i> Ver Resultados
                        </a>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-3 text-muted">
                    <i class="bi bi-clipboard-x" style="font-size: 2rem;"></i>
                    <p class="small mt-2 mb-0">No hay encuestas registradas</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Evolución del clima -->
            {% if evolucion_clima %}
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="bi bi-graph-up-arrow"></i> Evolución del Clima
                </h6>
                
                <canvas id="evolucionChart" height="200"></canvas>
                
                <div class="mt-3 small">
                    {% if tendencia == 'positiva' %}
                    <div class="alert alert-success mb-0 py-2">
                        <i class="bi bi-arrow-up-circle-fill"></i>
                        <strong>Tendencia positiva</strong> - El clima ha mejorado
                    </div>
                    {% elif tendencia == 'negativa' %}
                    <div class="alert alert-danger mb-0 py-2">
                        <i class="bi bi-arrow-down-circle-fill"></i>
                        <strong>Tendencia negativa</strong> - Requiere atención
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0 py-2">
                        <i class="bi bi-dash-circle-fill"></i>
                        <strong>Tendencia estable</strong> - Se mantiene constante
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Comparación por áreas -->
            {% if comparacion_areas %}
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="bi bi-diagram-3"></i> Comparación por Áreas
                </h6>
                
                {% for area in comparacion_areas %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>{{ area.nombre }}</small>
                        <strong class="
                            {% if area.puntaje >= 4.5 %}text-success
                            {% elif area.puntaje >= 3.5 %}text-primary
                            {% elif area.puntaje >= 2.5 %}text-warning
                            {% else %}text-danger
                            {% endif %}">
                            {{ area.puntaje|floatformat:1 }}
                        </strong>
                    </div>
                    <div class="dimension-bar">
                        <div class="dimension-fill 
                            {% if area.puntaje >= 4.5 %}nivel-excelente
                            {% elif area.puntaje >= 3.5 %}nivel-bueno
                            {% elif area.puntaje >= 2.5 %}nivel-regular
                            {% else %}nivel-deficiente
                            {% endif %}"
                             style="width: {{ area.porcentaje }}%">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Acciones recomendadas -->
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="bi bi-lightbulb"></i> Acciones Recomendadas
                </h6>
                
                <div class="list-group list-group-flush">
                    {% if clima_score < 3.0 %}
                    <div class="list-group-item px-0">
                        <i class="bi bi-exclamation-triangle text-danger"></i>
                        <small>Implementar plan de acción urgente</small>
                    </div>
                    {% endif %}
                    
                    {% if tasa_participacion < 60 %}
                    <div class="list-group-item px-0">
                        <i class="bi bi-megaphone text-warning"></i>
                        <small>Aumentar comunicación sobre encuestas</small>
                    </div>
                    {% endif %}
                    
                    <div class="list-group-item px-0">
                        <i class="bi bi-people text-info"></i>
                        <small>Realizar grupos focales por área</small>
                    </div>
                    
                    <div class="list-group-item px-0">
                        <i class="bi bi-calendar-check text-success"></i>
                        <small>Programar actividades de bienestar</small>
                    </div>
                    
                    <div class="list-group-item px-0">
                        <i class="bi bi-graph-up text-primary"></i>
                        <small>Dar seguimiento a plan de mejora</small>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Gráfica de evolución del clima
    {% if evolucion_clima %}
    const ctx = document.getElementById('evolucionChart').getContext('2d');
    const evolucionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ evolucion_labels|safe }},
            datasets: [{
                label: 'Clima Organizacional',
                data: {{ evolucion_data|safe }},
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}