{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    
    <h2 class="text-center mb-4">
        <i class="fas fa-hard-hat"></i> {{ title|default:"Registrar Proyecto" }}
    </h2>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    
                    {% if form.errors or formset.errors %}
                    <div class="alert alert-danger">
                        <strong>Errores en el formulario</strong>
                        {% for field in form %}
                            {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" id="proyectoForm">
                        {% csrf_token %}

                        <!-- Información Básica -->
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle text-primary"></i> Información Básica
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Constructora: <span class="text-danger">*</span></label>
                                {{ form.constructora }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Código del Proyecto: <span class="text-danger">*</span></label>
                                {{ form.codigo }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nombre del Proyecto: <span class="text-danger">*</span></label>
                            {{ form.nombre }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ubicación del Proyecto:</label>
                            {{ form.ubicacion }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripción:</label>
                            {{ form.descripcion }}
                        </div>

                        <!-- Fechas y Estado -->
                        <h5 class="mb-3 mt-4">
                            <i class="fas fa-calendar-alt text-primary"></i> Fechas y Estado
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Fecha de Inicio:</label>
                                {{ form.fecha_inicio }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha Fin Estimada:</label>
                                {{ form.fecha_fin_estimada }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha Fin Real:</label>
                                {{ form.fecha_fin_real }}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Estado: <span class="text-danger">*</span></label>
                                {{ form.estado }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado Financiero:</label>
                                {{ form.estado_financiero }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Porcentaje de Avance (%):</label>
                            {{ form.porcentaje_avance }}
                        </div>

                        <!-- Items Contratados -->
                        <h5 class="mb-3 mt-4">
                            <i class="fas fa-list text-primary"></i> Items Contratados
                        </h5>

                        <div id="items-container" class="mb-4">
                            {{ formset.management_form }}
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" id="items-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="35%">Item</th>
                                            <th width="15%">Unidad</th>
                                            <th width="15%">Cantidad</th>
                                            <th width="20%">Valor Unitario ($)</th>
                                            <th width="15%">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-tbody">
                                        {% for item_form in formset %}
                                        <tr class="item-row">
                                            <td>
                                                {{ item_form.id }}
                                                {{ item_form.item }}
                                                {{ item_form.DELETE }}
                                            </td>
                                            <td>{{ item_form.unidad }}</td>
                                            <td>{{ item_form.cantidad }}</td>
                                            <td>{{ item_form.valor_unitario }}</td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-danger remove-item">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <button type="button" id="add-item" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> Agregar Item
                            </button>
                        </div>

                        <!-- Presupuesto Total -->
                        <div class="alert alert-info">
                            <h5><i class="fas fa-calculator"></i> Presupuesto Total:</h5>
                            <h3 id="presupuesto-total">$0,00</h3>
                        </div>

                        <!-- Valores Financieros -->
                        <h5 class="mb-3 mt-4">
                            <i class="fas fa-dollar-sign text-primary"></i> Valores Financieros
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Valor Total del Proyecto:</label>
                                {{ form.valor_total }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Valor Pagado:</label>
                                {{ form.valor_pagado }}
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="mb-3">
                            <label class="form-label">Observaciones:</label>
                            {{ form.observaciones }}
                        </div>

                        <!-- Botones -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-save"></i> Guardar Proyecto
                            </button>
                            <a href="{% url 'administrativa:proyectos:listar_proyectos' %}" class="btn btn-secondary px-4">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsTableBody = document.getElementById('items-tbody');
    const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const formsetPrefix = '{{ formset.prefix }}';
    let emptyFormTemplate = null;

    // Función para calcular el presupuesto total
    function calcularPresupuesto() {
        let total = 0;
        const rows = document.querySelectorAll('.item-row:not(.to-delete)');
        
        rows.forEach(row => {
            const cantidadInput = row.querySelector('input[name$="-cantidad"]');
            const valorInput = row.querySelector('input[name$="-valor_unitario"]');
            
            if (cantidadInput && valorInput) {
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const valor = parseFloat(valorInput.value) || 0;
                total += cantidad * valor;
            }
        });

        document.getElementById('presupuesto-total').textContent = 
            '$' + total.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // Actualizar valor_total
        const valorTotalInput = document.querySelector('input[name="valor_total"]');
        if (valorTotalInput) {
            valorTotalInput.value = total.toFixed(2);
        }
    }

    // Agregar listeners a las filas existentes
    document.querySelectorAll('.item-row').forEach(row => {
        const cantidadInput = row.querySelector('input[name$="-cantidad"]');
        const valorInput = row.querySelector('input[name$="-valor_unitario"]');
        
        if (cantidadInput) {
            cantidadInput.addEventListener('input', calcularPresupuesto);
        }
        if (valorInput) {
            valorInput.addEventListener('input', calcularPresupuesto);
        }
        
        const deleteBtn = row.querySelector('.remove-item');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    row.classList.add('to-delete');
                    row.style.display = 'none';
                } else {
                    row.remove();
                }
                calcularPresupuesto();
            });
        }
    });

    // Botón para agregar nuevo item
    document.getElementById('add-item').addEventListener('click', function() {
        const formIdx = parseInt(totalForms.value);
        
        const newRow = document.createElement('tr');
        newRow.className = 'item-row';
        newRow.innerHTML = `
            <td><input type="text" name="${formsetPrefix}-${formIdx}-item" class="form-control" placeholder="Ej: Closet Alcoba Principal"></td>
            <td><input type="text" name="${formsetPrefix}-${formIdx}-unidad" class="form-control" placeholder="unidad"></td>
            <td><input type="number" step="0.01" name="${formsetPrefix}-${formIdx}-cantidad" class="form-control" placeholder="0"></td>
            <td><input type="number" step="0.01" name="${formsetPrefix}-${formIdx}-valor_unitario" class="form-control" placeholder="0"></td>
            <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-item"><i class="fas fa-trash"></i></button></td>
        `;
        
        itemsTableBody.appendChild(newRow);
        totalForms.value = formIdx + 1;
        
        // Agregar listeners al nuevo row
        const cantidadInput = newRow.querySelector('input[name$="-cantidad"]');
        const valorInput = newRow.querySelector('input[name$="-valor_unitario"]');
        
        if (cantidadInput) cantidadInput.addEventListener('input', calcularPresupuesto);
        if (valorInput) valorInput.addEventListener('input', calcularPresupuesto);
        
        const deleteBtn = newRow.querySelector('.remove-item');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                newRow.remove();
                calcularPresupuesto();
            });
        }
        
        calcularPresupuesto();
    });

    // Calcular presupuesto inicial
    calcularPresupuesto();
});
</script>
{% endblock %}