{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <!-- TÃ­tulo -->
    <h2 class="section-title text-center mb-4">
        <i class="fas fa-clipboard-list"></i> GestiÃ³n de Ã“rdenes de Trabajo
    </h2>

    <!-- Botones -->
    <div class="text-center mb-3">
        <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
            <a href="{% url 'administrativa:ordenes:crear_orden' %}" class="btn-module">
                <i class="fas fa-plus"></i> Nueva OT
            </a>
            <button id="refresh-btn" class="btn-module btn-refresh">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
        <div id="clock" class="clock-display mt-3"></div>
    </div>

    <!-- Contadores -->
    <div class="stats-box text-center mb-4">
        <span class="me-4">ðŸ˜€ <strong>Cierres a tiempo:</strong> {{ cierres_a_tiempo }}</span>
        <span>ðŸ˜ž <strong>Cierres tardÃ­os:</strong> {{ cierres_tardios }}</span>
    </div>

    <!-- Tabla -->
    <div class="table-container">
        <table class="table-modern">
            <thead>
                <tr>
                    <th>NÃºmero</th>
                    <th>Constructora</th>
                    <th>Proyecto</th>
                    <th>Proceso</th>
                    <th>DescripciÃ³n</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha EnvÃ­o</th>
                    <th>Estado</th>
                    <th>Fecha Cierre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for ot in ordenes %}
                <tr>
                    <td>{{ ot.numero }}</td>
                    <td>{{ ot.get_constructora_display }}</td>
                    <td>{{ ot.get_proyecto_display }}</td>
                    <td>{{ ot.get_proceso_display }}</td>
                    <td>{{ ot.descripcion }}</td>
                    <td>{{ ot.fecha_apertura|date:"d/m/Y H:i" }}</td>
                    <td>{{ ot.fecha_envio|date:"d/m/Y" }}</td>
                    <td>
                        <span class="badge 
                            {% if ot.estado == 'abierta' %}bg-warning
                            {% elif ot.estado == 'en_proceso' %}bg-info
                            {% else %}bg-success{% endif %}">
                            {{ ot.get_estado_display }}
                        </span>
                    </td>
                    <td>
                        {% if ot.fecha_cierre %}
                            {{ ot.fecha_cierre|date:"d/m/Y" }}
                            {% if ot.cierre_a_tiempo %} ðŸ˜€ {% else %} ðŸ˜ž {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="acciones-cell">
                        <div class="acciones-wrapper">

                            <!-- ðŸ“ Carpeta Documentos -->
                            <button class="btn-icon folder" onclick="openModal('{{ ot.id }}')" title="Documentos">
                                <i class="fas fa-folder-open"></i>
                            </button>

                            <!-- ðŸªŸ Modal Documentos -->
<div id="docModal-{{ ot.id }}" class="modal-doc">
  <div class="modal-doc-content">
    <div class="modal-doc-header">
      <h5><i class="fas fa-folder-open text-warning"></i> Documentos de {{ ot.numero }}</h5>
      <button class="modal-doc-close" onclick="closeModal('{{ ot.id }}')">&times;</button>
    </div>

    <ul class="document-list">
      {% if ot.documentos.all %}
        {% for doc in ot.documentos.all %}
        <li>
          <span>ðŸ“„ {{ doc.archivo.name|cut:"ordenes/" }}</span>
          <div class="d-flex gap-2">
            {% if doc.archivo %}
              <!-- ðŸ–¥ï¸ Enlace directo desde tu PC vÃ­a ngrok -->
              <a href="https://unfledged-unsalably-laticia.ngrok-free.dev/media/{{ doc.archivo.name }}" 
                 class="btn-icon-mini" title="Abrir desde tu PC" target="_blank">
                <i class="fas fa-folder-open text-success"></i>
              </a>

              <!-- ðŸ”— Enlace alternativo desde Django (Render o local) -->
              <a href="{{ doc.archivo.url }}" target="_blank" class="btn-icon-mini" title="Ver desde Django">
                <i class="fas fa-eye text-primary"></i>
              </a>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      {% else %}
        <li class="text-muted text-center py-3">No hay documentos guardados</li>
      {% endif %}
    </ul>
  </div>
</div>


    <!-- Logos -->
    <div class="text-center my-5">
        <img src="{% static 'img/logo1.png' %}" alt="NexusOne" height="90" class="mx-4 logo-animado">
        <img src="{% static 'img/logo2.png' %}" alt="Empresa Aliada" height="90" class="mx-4 logo-animado">
    </div>
</div>

<!-- Script reloj y modales -->
<script>
function updateClock() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const timeStr = now.toLocaleTimeString('es-ES');
    document.getElementById('clock').innerHTML = dateStr + " â€” " + timeStr;
}
setInterval(updateClock, 1000);
updateClock();

// ðŸ”„ Refrescar pÃ¡gina
document.getElementById('refresh-btn').addEventListener('click', function() {
    const icon = this.querySelector('i');
    icon.classList.add('fa-spin');
    setTimeout(() => { location.reload(); }, 500);
});

// ðŸ“‚ Abrir/Cerrar modal
function openModal(id) { document.getElementById('docModal-' + id).classList.add('active'); }
function closeModal(id) { document.getElementById('docModal-' + id).classList.remove('active'); }
document.querySelectorAll('.modal-doc').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});
</script>

<!-- Estilos -->
<style>
.modal-doc {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.modal-doc.active { display: flex; }
.modal-doc-content {
    background: #fff;
    border-radius: 12px;
    width: 70vw;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px 30px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    animation: zoomIn 0.25s ease;
}
@keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.modal-doc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.modal-doc-header h5 { margin: 0; font-size: 18px; color: var(--primary); }
.modal-doc-close {
    background: none; border: none; font-size: 24px;
    color: var(--gray); cursor: pointer;
}
.modal-doc-close:hover { color: var(--danger); }
.document-list { list-style: none; padding: 0; margin: 0; }
.document-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 8px 0;
}
.document-list li:last-child { border-bottom: none; }
.btn-icon-mini {
    width: 26px; height: 26px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #f3f3f3;
    border-radius: 5px;
    transition: all 0.2s ease;
}
.btn-icon-mini:hover {
    background: #e2e6ea;
    transform: scale(1.1);
}
</style>
{% endblock %}
