{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <!-- Título -->
    <h2 class="section-title text-center mb-4">
        <i class="fas fa-clipboard-list"></i> Gestión de Órdenes de Trabajo
    </h2>

    <!-- Botones -->
    <div class="text-center mb-3">
        <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
            <a href="{% url 'administrativa:ordenes:crear_orden' %}" class="btn-module">
                <i class="fas fa-plus"></i> Nueva OT
            </a>
            <button id="refresh-btn" class="btn-module btn-refresh">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
        <div id="clock" class="clock-display mt-3"></div>
    </div>

    <!-- Contadores -->
    <div class="stats-box text-center mb-4">
        <span class="me-4">😀 <strong>Cierres a tiempo:</strong> {{ cierres_a_tiempo }}</span>
        <span>😞 <strong>Cierres tardíos:</strong> {{ cierres_tardios }}</span>
    </div>

    <!-- Tabla -->
    <div class="table-container">
        <table class="table-modern">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Constructora</th>
                    <th>Proyecto</th>
                    <th>Proceso</th>
                    <th>Descripción</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha Envío</th>
                    <th>Estado</th>
                    <th>Fecha Cierre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for ot in ordenes %}
                <tr>
                    <td>{{ ot.numero }}</td>
                    <td>{{ ot.get_constructora_display }}</td>
                    <td>{{ ot.get_proyecto_display }}</td>
                    <td>{{ ot.get_proceso_display }}</td>
                    <td>{{ ot.descripcion }}</td>
                    <td>{{ ot.fecha_apertura|date:"d/m/Y H:i" }}</td>
                    <td>{{ ot.fecha_envio|date:"d/m/Y" }}</td>
                    <td>
                        <span class="badge 
                            {% if ot.estado == 'abierta' %}bg-warning
                            {% elif ot.estado == 'en_proceso' %}bg-info
                            {% else %}bg-success{% endif %}">
                            {{ ot.get_estado_display }}
                        </span>
                    </td>
                    <td>
                        {% if ot.fecha_cierre %}
                            {{ ot.fecha_cierre|date:"d/m/Y" }}
                            {% if ot.cierre_a_tiempo %} 😀 {% else %} 😞 {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="acciones-cell">
                        <div class="acciones-wrapper">

                            <!-- 📁 Carpeta Documentos -->
                            <button class="btn-icon folder" onclick="openModal('{{ ot.id }}', '{{ ot.numero }}')" title="Documentos">
                                <i class="fas fa-folder-open"></i>
                            </button>

                            <!-- 🪟 Modal Documentos -->
                            <div id="docModal-{{ ot.id }}" class="modal-doc">
                                <div class="modal-doc-content">
                                    <div class="modal-doc-header">
                                        <h5><i class="fas fa-folder-open text-warning"></i> Documentos de {{ ot.numero }}</h5>
                                        <button class="modal-doc-close" onclick="closeModal('{{ ot.id }}')">&times;</button>
                                    </div>

                                    <ul class="document-list" id="docList-{{ ot.id }}">
                                        <li class="text-muted text-center py-3">Cargando archivos...</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- ✏️ Editar -->
                            {% if ot.estado != "cerrada" %}
                                <a href="{% url 'administrativa:ordenes:editar_orden' ot.id %}" class="btn-icon edit" title="Editar">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a href="{% url 'administrativa:ordenes:cerrar_orden' ot.id %}" 
                                   class="btn-icon close" title="Cerrar"
                                   onclick="return confirm('¿Seguro que deseas cerrar esta OT?');">
                                    <i class="fas fa-check"></i>
                                </a>
                            {% else %}
                                <span class="btn-icon edit disabled" title="Editar bloqueado">
                                    <i class="fas fa-pencil-alt"></i>
                                </span>
                            {% endif %}

                            <!-- 🗑️ Eliminar -->
                            <a href="{% url 'administrativa:ordenes:eliminar_orden' ot.id %}" 
                               class="btn-icon delete" title="Eliminar"
                               onclick="return confirm('¿Seguro que deseas eliminar esta OT?');">
                                <i class="fas fa-trash"></i>
                            </a>

                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center">No hay órdenes de trabajo registradas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Logos -->
    <div class="text-center my-5">
        <img src="{% static 'img/logo1.png' %}" alt="NexusOne" height="90" class="mx-4 logo-animado">
        <img src="{% static 'img/logo2.png' %}" alt="Empresa Aliada" height="90" class="mx-4 logo-animado">
    </div>
</div>

<!-- Script reloj y modales -->
<script>
const NGROK_URL = "{{ ngrok_url }}";

function updateClock() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const timeStr = now.toLocaleTimeString('es-ES');
    document.getElementById('clock').innerHTML = dateStr + " — " + timeStr;
}
setInterval(updateClock, 1000);
updateClock();

// 🔄 Refrescar página
document.getElementById('refresh-btn').addEventListener('click', function() {
    const icon = this.querySelector('i');
    icon.classList.add('fa-spin');
    setTimeout(() => { location.reload(); }, 500);
});

// 📂 Abrir modal y cargar archivos desde la PC
async function openModal(id, numeroOT) {
    const modal = document.getElementById('docModal-' + id);
    modal.classList.add('active');
    
    const docList = document.getElementById('docList-' + id);
    docList.innerHTML = '<li class="text-muted text-center py-3">Cargando archivos...</li>';
    
    try {
        const response = await fetch(`/administrativa/ordenes/listar-archivos-local/?numero_ot=${numeroOT}`);
        const data = await response.json();
        
        if (data.archivos && data.archivos.length > 0) {
            docList.innerHTML = data.archivos.map(archivo => `
                <li>
                    <span>📄 ${archivo}</span>
                    <div class="d-flex gap-2">
                        <a href="${NGROK_URL}/Ordenes/${numeroOT}/${archivo}" 
                           class="btn-icon-mini" title="Descargar desde tu PC" target="_blank">
                            <i class="fas fa-download text-success"></i>
                        </a>
                    </div>
                </li>
            `).join('');
        } else {
            docList.innerHTML = '<li class="text-muted text-center py-3">No hay documentos cargados</li>';
        }
    } catch (error) {
        docList.innerHTML = '<li class="text-danger text-center py-3">Error al cargar archivos</li>';
        console.error('Error:', error);
    }
}

function closeModal(id) { 
    document.getElementById('docModal-' + id).classList.remove('active'); 
}

document.querySelectorAll('.modal-doc').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});
</script>

<!-- Estilos -->
<style>
.modal-doc {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.modal-doc.active { display: flex; }
.modal-doc-content {
    background: #fff;
    border-radius: 12px;
    width: 70vw;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px 30px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    animation: zoomIn 0.25s ease;
}
@keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.modal-doc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.modal-doc-header h5 { margin: 0; font-size: 18px; color: var(--primary); }
.modal-doc-close {
    background: none; border: none; font-size: 24px;
    color: var(--gray); cursor: pointer;
}
.modal-doc-close:hover { color: var(--danger); }
.document-list { list-style: none; padding: 0; margin: 0; }
.document-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 8px 0;
}
.document-list li:last-child { border-bottom: none; }
.btn-icon-mini {
    width: 26px; height: 26px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #f3f3f3;
    border-radius: 5px;
    transition: all 0.2s ease;
}
.btn-icon-mini:hover {
    background: #e2e6ea;
    transform: scale(1.1);
}
</style>
{% endblock %}