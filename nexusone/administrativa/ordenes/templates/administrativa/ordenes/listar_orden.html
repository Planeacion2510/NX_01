{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="section-title text-center mb-4">
        <i class="fas fa-clipboard-list"></i> Gestión de Órdenes de Trabajo
    </h2>

    <div class="text-center mb-3">
        <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
            <a href="{% url 'administrativa:ordenes:crear_orden' %}" class="btn-module">
                <i class="fas fa-plus"></i> Nueva OT
            </a>
        </div>
    </div>

    <div class="table-container">
        <table class="table-modern">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Constructora</th>
                    <th>Proyecto</th>
                    <th>Proceso</th>
                    <th>Descripción</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha Envío</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for ot in ordenes %}
                <tr>
                    <td>{{ ot.numero }}</td>
                    <td>{{ ot.get_constructora_display }}</td>
                    <td>{{ ot.get_proyecto_display }}</td>
                    <td>{{ ot.get_proceso_display }}</td>
                    <td>{{ ot.descripcion }}</td>
                    <td>{{ ot.fecha_apertura|date:"d/m/Y" }}</td>
                    <td>{{ ot.fecha_envio|date:"d/m/Y" }}</td>
                    <td>{{ ot.get_estado_display }}</td>
                    <td>
                        <!-- 📂 Botón de documentos -->
                        <button class="btn-icon folder" onclick="openModal('{{ ot.id }}')">
                            <i class="fas fa-folder-open"></i>
                        </button>

                        <!-- Modal de documentos -->
                        <div id="docModal-{{ ot.id }}" class="modal-doc">
                            <div class="modal-doc-content">
                                <div class="modal-doc-header">
                                    <h5><i class="fas fa-folder-open text-warning"></i> Documentos de {{ ot.numero }}</h5>
                                    <button class="modal-doc-close" onclick="closeModal('{{ ot.id }}')">&times;</button>
                                </div>

                                <ul class="document-list">
                                    {% if ot.documentos.exists %}
                                        {% for doc in ot.documentos.all %}
                                            <li>
                                                <span>📄 {{ doc.nombre|default:doc.archivo.name }}</span>
                                                <div class="d-flex gap-2">
                                                    {% if doc.archivo %}
                                                        <a href="{{ doc.archivo.url }}" target="_blank" class="btn-icon-mini" title="Ver">
                                                            <i class="fas fa-eye text-primary"></i>
                                                        </a>
                                                        <a href="{{ doc.archivo.url }}" download class="btn-icon-mini" title="Descargar">
                                                            <i class="fas fa-download text-success"></i>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </li>
                                        {% endfor %}
                                    {% else %}
                                        <li class="text-muted text-center py-3">No hay documentos cargados</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="9" class="text-center">No hay órdenes registradas</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Script del modal -->
<script>
function openModal(id) {
    document.getElementById('docModal-' + id).classList.add('active');
}
function closeModal(id) {
    document.getElementById('docModal-' + id).classList.remove('active');
}
// cerrar al hacer clic fuera del cuadro
document.querySelectorAll('.modal-doc').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});
</script>
{% endblock %}
